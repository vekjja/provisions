- name: Ensure netplan is installed
  become: true
  apt:
    name: netplan.io
    state: present
    update_cache: true

- name: Find existing Netplan configuration files
  become: true
  find:
    paths: /etc/netplan
    patterns: "*.yaml,*.yml"
    file_type: file
  register: netplan_files

- name: Backup existing Netplan configuration
  become: true
  when: 
    - netplan_files.files | length > 0
  copy:
    src: "{{ item.path }}"
    dest: "{{ item.path }}.backup"
    remote_src: true
  loop: "{{ netplan_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Create Netplan static IP configuration
  become: true
  copy:
    dest: /etc/netplan/99-static-ip-config.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          {{ static_ip.interface }}:
            dhcp4: no
            addresses: [{{ static_ip.address }}/{{ static_ip.netmask | default('24') }}]
            routes:
              - to: default
                via: {{ static_ip.gateway }}
            nameservers:
              addresses: {{ static_ip.nameservers | default(['8.8.8.8', '8.8.4.4']) }}
              {% if static_ip.search is defined %}
              search: {{ static_ip.search }}
              {% endif %}
    mode: '0644'
    owner: root
    group: root

- name: Apply Netplan configuration
  become: true
  command: netplan apply
  register: netplan_apply_result
  changed_when: true

- name: Ensure hostname is in /etc/hosts
  become: true
  lineinfile:
    path: /etc/hosts
    regexp: '^\s*{{ static_ip.address }}\s+'
    line: "{{ static_ip.address }} {{ static_ip.hostname | default(ansible_facts['hostname']) }} {{ ansible_facts['hostname'] }} {{ ansible_facts['fqdn'] | default(ansible_facts['hostname']) }}"
    state: present
    backup: true

- name: Verify static IP configuration
  become: true
  command: ip addr show {{ static_ip.interface }}
  register: ip_show_result
  changed_when: false

- name: Display IP configuration
  debug:
    var: ip_show_result.stdout_lines
