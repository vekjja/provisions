- name: Ensure netplan is installed
  become: true
  when: static_ip is defined
  apt:
    name: netplan.io
    state: present
    update_cache: true

- name: Find existing Netplan configuration files
  become: true
  when: static_ip is defined
  find:
    paths: /etc/netplan
    patterns: "*.yaml,*.yml"
    file_type: file
  register: netplan_files

- name: Backup existing Netplan configuration
  become: true
  when: 
    - static_ip is defined
    - netplan_files.files | length > 0
  copy:
    src: "{{ item.path }}"
    dest: "{{ item.path }}.backup"
    remote_src: true
  loop: "{{ netplan_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Create Netplan static IP configuration
  become: true
  when: static_ip is defined
  copy:
    dest: /etc/netplan/99-static-ip-config.yaml
    content: |
      network:
        version: 2
        renderer: networkd
        ethernets:
          {{ static_ip.interface }}:
            dhcp4: no
            addresses: [{{ static_ip.address }}/{{ static_ip.netmask | default('24') }}]
            routes:
              - to: default
                via: {{ static_ip.gateway }}
            nameservers:
              addresses: {{ static_ip.nameservers | default(['8.8.8.8', '8.8.4.4']) }}
              {% if static_ip.search is defined %}
              search: {{ static_ip.search }}
              {% endif %}
    mode: '0644'
    owner: root
    group: root

- name: Apply Netplan configuration
  become: true
  when: static_ip is defined
  command: netplan apply
  register: netplan_apply_result
  changed_when: true

- name: Ensure hostname is in /etc/hosts
  become: true
  when: static_ip is defined
  lineinfile:
    path: /etc/hosts
    regexp: '^\s*{{ static_ip.address }}\s+'
    line: "{{ static_ip.address }} {{ static_ip.hostname | default(ansible_facts['hostname']) }} {{ ansible_facts['hostname'] }} {{ ansible_facts['fqdn'] | default(ansible_facts['hostname']) }}"
    state: present
    backup: true

- name: Verify static IP configuration
  become: true
  when: static_ip is defined
  command: ip addr show {{ static_ip.interface }}
  register: ip_show_result
  changed_when: false

- name: Display IP configuration
  when: static_ip is defined
  debug:
    var: ip_show_result.stdout_lines

- name: Ensure UFW is installed
  become: true
  apt:
    name: ufw
    state: present
    update_cache: true

- name: Configure UFW firewall rules
  become: true
  ufw:
    rule: "{{ item.rule | default('allow') }}"
    port: "{{ item.port | default(omit) }}"
    proto: "{{ item.proto | default('tcp') }}"
    from: "{{ item.from | default(omit) }}"
    comment: "{{ item.comment | default(omit) }}"
  loop: "{{ firewall_rules | default([]) }}"
  when: firewall_rules is defined

- name: Allow NFS from local network (TCP)
  become: true
  when: 
    - static_ip is defined
    - firewall_rules is defined
  ufw:
    rule: allow
    from: "{{ static_ip.address | regex_replace('^([0-9]+\\.[0-9]+)\\.[0-9]+\\.[0-9]+$', '\\1.0.0') }}/{{ static_ip.netmask | default('16') }}"
    port: '111,2049'
    proto: tcp
    comment: 'NFS from local network (TCP)'

- name: Allow NFS from local network (UDP)
  become: true
  when: 
    - static_ip is defined
    - firewall_rules is defined
  ufw:
    rule: allow
    from: "{{ static_ip.address | regex_replace('^([0-9]+\\.[0-9]+)\\.[0-9]+\\.[0-9]+$', '\\1.0.0') }}/{{ static_ip.netmask | default('16') }}"
    port: '111,2049'
    proto: udp
    comment: 'NFS from local network (UDP)'

