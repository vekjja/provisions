# Default values for kube-prometheus-stack
# https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack

# Enable Grafana (included in kube-prometheus-stack, pre-configured with Prometheus)
grafana:
  enabled: true

  # Admin credentials
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password

  # Persistence
  persistence:
    enabled: true
    storageClassName: "local-path"
    size: 10Gi

  # Disable init container that changes ownership (causes issues with local-path storage)
  initChownData:
    enabled: false

  # Ingress
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: cloudflare-letsencrypt-production
    hosts:
    - graf.livingroom.cloud
    path: /
    pathType: Prefix
    tls:
    - secretName: graf.livingroom.cloud-tls
      hosts:
      - graf.livingroom.cloud

  # Resources
  resources:
    limits:
      cpu: 1000m
      memory: 1024Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Service
  service:
    type: ClusterIP
    port: 80

  # Dashboard configuration
  defaultDashboardsEnabled: false

  # Sidecar for auto-discovering dashboards from ConfigMaps
  # Any ConfigMap with label "grafana_dashboard: 1" will be automatically loaded
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      # Search in all namespaces or specific namespace
      searchNamespace: ALL

  # Datasources - configure Loki for logging
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        isDefault: false
        jsonData:
          maxLines: 1000

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Scrape interval - how often to collect metrics (default is 30s)
    scrapeInterval: 6s
    scrapeTimeout: 10s

    # Evaluation interval - how often to evaluate rules (default is 30s)
    evaluationInterval: 15s

    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: "local-path"
          accessModes: [ "ReadWriteOnce" ]
          resources:
            requests:
              storage: 50Gi

    # Resource limits
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 2Gi

    # Service configuration
    service:
      type: ClusterIP
      port: 9090

  # Prometheus ingress (disabled - access via port-forward if needed)
  ingress:
    enabled: false

# Alertmanager configuration (disabled for now)
alertmanager:
  enabled: false

# Node Exporter (collects node metrics)
nodeExporter:
  enabled: true

# prometheus-node-exporter:
#   extraArgs:
#   # Keep kube-prometheus-stack's default filesystem exclusions to avoid noisy/duplicated mount metrics
#   - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/containerd/.+|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
#   - --collector.filesystem.fs-types-exclude=^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs|erofs)$
#   - --collector.systemd
#   - --collector.processes

# Kube State Metrics (collects Kubernetes resource metrics)
kubeStateMetrics:
  enabled: true

# Prometheus Operator
prometheusOperator:
  enabled: true
  resources:
    limits:
      cpu: 200m
      memory: 200Mi
    requests:
      cpu: 100m
      memory: 100Mi
