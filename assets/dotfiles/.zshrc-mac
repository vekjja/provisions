# ZSH

## Apple Homebrew ##
export PATH="/opt/homebrew/bin:$PATH"
export PATH="/opt/homebrew/sbin:$PATH"

#### Go ####
export GOROOT="$(brew --prefix golang)/libexec"

# Postgres
export PATH="/usr/local/opt/libpq/bin:$PATH"

#### iTerm ####
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# Source all .zshrc-* files
for file in ~/.zshrc-*; do
  [ -e "$file" ] && source "$file"
done

if [ -f ~/.apks ]; then
  source ~/.apks
fi

## Mac Aliases
alias f=ranger
alias du="gdu-go"
alias flush_dns="sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder"
alias showHidden="defaults write com.apple.finder AppleShowAllFiles YES"
alias macInfo="system_profiler SPSoftwareDataType SPHardwareDataType"
function copy() {
  cat "$@" | pbcopy
}

## SMB
smb_mount() {
  local share_name="${1:-tera}"
  local mount_point="/Volumes/${share_name}"
  local server="10.0.0.10"
  
  if [ -z "$SMB_UNPW" ]; then
    echo "Error: SMB_UNPW environment variable is not set (format: username:password)"
    return 1
  fi
  
  # Unmount if already mounted
  if mount | grep -q "$mount_point"; then
    echo "Unmounting existing mount..."
    sudo umount "$mount_point" 2>/dev/null || true
  fi
  
  # Create mount point if it doesn't exist
  if [ ! -d "$mount_point" ]; then
    sudo mkdir -p "$mount_point" 2>/dev/null
    sudo chown -R "$(id -un):$(id -gn)" "$mount_point"
  fi
  
  # Mount the share using smb:// format with password in URL
  mount_smbfs -f 0644 -d 0755 "smb://${SMB_UNPW}@${server}/${share_name}" "$mount_point"
  
  if [ $? -eq 0 ]; then
    echo "Successfully mounted ${share_name} share to ${mount_point}"
  else
    echo "Failed to mount ${share_name} share"
    return 1
  fi
}

# Delete downloaded Apple moving wallpapers (macOS Sonoma+)
# Usage:
#   clean_apple_moving_wallpapers           # delete system-wide cache (requires sudo)
clean_apple_moving_wallpapers() {
  local SYSTEM_PATH="/Library/Application Support/com.apple.idleassetsd/Customer"
  local USER_PATH="$HOME/Library/Application Support/com.apple.idleassetsd/Customer"
  local TARGETS=()
  local DRY_RUN=0
  local USER_ONLY=0

  # Parse flags
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run) DRY_RUN=1; shift ;;
      --user) USER_ONLY=1; shift ;;
      -h|--help)
        echo "Delete downloaded Apple moving wallpaper video assets (.mov)."
        echo "Usage:"
        echo "  clean_apple_moving_wallpapers           # delete system-wide cache (requires sudo)"
        echo "  clean_apple_moving_wallpapers --dry-run # list what would be deleted"
        echo "  clean_apple_moving_wallpapers --user    # clean only current user's cache (no sudo)"
        echo "Options:"
        echo "  --dry-run   List files and actions without deleting"
        echo "  --user      Operate only on the current user's cache: \"$USER_PATH\""
        return 0
        ;;
      *)
        echo "Unknown option: $1" >&2
        return 2
        ;;
    esac
  done

  # Build target paths
  if [[ $USER_ONLY -eq 1 ]]; then
    TARGETS+=("$USER_PATH")
  else
    TARGETS+=("$SYSTEM_PATH" "$USER_PATH")
  fi

  # Check macOS version (Sonoma 14+ recommended)
  local PRODUCT_VERSION
  PRODUCT_VERSION=$(sw_vers -productVersion 2>/dev/null || echo "")
  if [[ -n "$PRODUCT_VERSION" ]]; then
    echo "macOS version: $PRODUCT_VERSION"
  fi

  # Advise switching to static wallpaper to avoid 'in use' or redownload
  echo "Tip: Switch to a static wallpaper in System Settings → Wallpaper before cleaning."

  # Quit wallpaper-related processes (safe even in dry-run)
  echo "Stopping wallpaper services..."
  killall Wallpaper 2>/dev/null || true
  killall "Wallpaper (System Settings)" 2>/dev/null || true
  killall idleassetsd 2>/dev/null || true

  # For each target path, list and delete .mov files
  local found_any=0
  for path in "${TARGETS[@]}"; do
    if [[ -d "$path" ]]; then
      echo "Scanning: $path"
      local list_cmd=("find" "$path" "-type" "f" "-name" "*.mov")
      local files
      files=$("${list_cmd[@]}" 2>/dev/null)
      if [[ -n "$files" ]]; then
        found_any=1
        echo "Found the following video assets:"
        echo "$files"
        if [[ $DRY_RUN -eq 1 ]]; then
          echo "[DRY-RUN] Skipping deletion for: $path"
        else
          # System path usually needs sudo; user path does not
          if [[ "$path" == "$SYSTEM_PATH" && $USER_ONLY -ne 1 ]]; then
            echo "Deleting system-wide assets (sudo may prompt for password)..."
            sudo find "$path" -type f -name "*.mov" -exec rm -f {} + 2>/dev/null
          else
            echo "Deleting user assets..."
            find "$path" -type f -name "*.mov" -exec rm -f {} + 2>/dev/null
          fi
          echo "Removing empty directories in: $path"
          if [[ "$path" == "$SYSTEM_PATH" && $USER_ONLY -ne 1 ]]; then
            sudo find "$path" -type d -empty -delete 2>/dev/null
          else
            find "$path" -type d -empty -delete 2>/dev/null
          fi
        fi
      else
        echo "No .mov assets found in: $path"
      fi
    else
      echo "Path not present: $path"
    fi
  done

  if [[ $found_any -eq 0 ]]; then
    echo "No downloaded moving wallpaper videos were found."
  fi

  # Restart idleassetsd to refresh state
  echo "Restarting idleassetsd..."
  if [[ $DRY_RUN -eq 1 ]]; then
    echo "[DRY-RUN] Would run: launchctl kickstart -k system/com.apple.idleassetsd"
  else
    # Use sudo when operating on system path
    if [[ $USER_ONLY -ne 1 ]]; then
      sudo launchctl kickstart -k system/com.apple.idleassetsd 2>/dev/null || true
    else
      launchctl kickstart -k gui/$(id -u)/com.apple.idleassetsd 2>/dev/null || true
    fi
  fi

  echo "Done. If the UI still shows moving sets, that's expected—selecting them will re-download assets."
}
